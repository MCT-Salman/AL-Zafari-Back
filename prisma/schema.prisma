generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------

/**
 * ===================== ENUMS =====================
 */

enum UserRole {
  admin
  accountant
  cashier
  sales
  production_manager
  Warehouse_Keeper
  Warehouse_Products
  Dissection_Technician
  Cutting_Technician
  Gluing_Technician
}

enum CustomerType {
  Branch
  agent
  customer
}

enum MaterialType {
  Role
  Blanck
}

enum RulerType {
  old
  new
}

enum ActivityAction {
  SEARCH
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  EXPORT
}

enum NotificationType {
  GENERAL
  COURSE_NEW
  COURSE_UPDATE
  LESSON_NEW
  QUIZ_AVAILABLE
  SYSTEM
}

enum PriceColorBy {
  isByMeter22
  isByMeter44
  isByMeter66
  isByBlanck
}

enum ConstantTypeEnum {
  width
  height
  thickness
  type_order
  source_order
}

enum OrderStatus {
  pending
  preparing
  canceled
  completed
}

enum ProductionType {
  orderproduction
  warehouse
  slitting
  cutting
  gluing
}

enum ProductionStatus {
  pending
  preparing
  canceled
  completed
}

enum MovementDestination {
  slitting
  cutting
  production
}

enum ProcessSource {
  warehouse
  slitting
  cutting
  production
}

/**
 * ===================== MODELS =====================
 */

model Users {
  id               Int      @id @default(autoincrement())
  phone            String   @unique
  username         String   @unique
  password         String
  full_name        String
  role             UserRole
  country          String?
  countryCode      String?
  is_active        Boolean  @default(true)
  currentSessionId String?  @unique
  fcmToken         String?
  notes            String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  orders        Order[]
  invoices      Invoice[]
  processes     ProductionProcess[]
  productions   ProductionOrder[]
  movements     WarehouseMovement[]
  slites        Slite[]
  sessions      Session[]
  refreshTokens RefreshToken[]
  loginAttempts LoginAttempt[]
  notification  Notification[]
  auditLog      AuditLog[]
  activityLogs  ActivityLog[]

  @@map("Users")
}

model Session {
  id         String    @id @default(cuid())
  user       Users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  userAgent  String?
  ip         String?
  realIp     String?
  location   String?
  deviceInfo String?
  created_at DateTime  @default(now())
  revokedAt  DateTime?

  refreshTokens RefreshToken[]

  @@index([userId])
  @@index([realIp])
  @@map("Session")
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  tokenHash  String    @unique
  user       Users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId  String
  expiresAt  DateTime
  isRevoked  Boolean   @default(false)
  revokedAt  DateTime?
  created_at DateTime  @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([tokenHash])
  @@map("RefreshToken")
}

model LoginAttempt {
  id            Int      @id @default(autoincrement())
  identifier    String
  user          Users?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        Int?
  ip            String
  userAgent     String?
  success       Boolean  @default(false)
  failureReason String?
  created_at    DateTime @default(now())

  @@index([identifier])
  @@index([ip])
  @@index([created_at])
  @@map("LoginAttempt")
}

model Notification {
  id         Int              @id @default(autoincrement())
  userId     Int?
  user       Users?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title      String
  body       String
  type       NotificationType @default(GENERAL)
  data       Json?
  isRead     Boolean          @default(false)
  link       String?
  imageUrl   String?
  sentToFCM  Boolean          @default(false)
  created_at DateTime         @default(now())

  @@index([userId])
  @@index([created_at])
  @@index([type])
  @@map("Notification")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  actorId    Int?
  actor      Users?   @relation(fields: [actorId], references: [id], onDelete: Cascade)
  action     String
  resource   String?
  meta       Json?
  created_at DateTime @default(now())

  @@index([created_at])
  @@map("AuditLog")
}

model ActivityLog {
  id          Int            @id @default(autoincrement())
  userId      Int?
  user        Users?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      ActivityAction
  module      String
  entityId    Int?
  entityRef   String?
  searchQuery String?
  oldData     Json?
  newData     Json?
  ip          String?
  userAgent   String?
  createdAt   DateTime       @default(now())

  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([createdAt])
  @@map("ActivityLog")
}

model RateLimit {
  id         Int       @id @default(autoincrement())
  key        String
  attempts   Int       @default(0)
  windowEnd  DateTime?
  created_at DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([key])
  @@map("RateLimit")
}

model Customer {
  customer_id   Int          @id @default(autoincrement())
  name          String
  phone         String
  customer_type CustomerType
  city          String
  address       String
  country       String?
  countryCode   String?
  balance         Decimal  @default(0.00)
  is_active     Boolean      @default(true)
  fcmToken      String?
  notes         String?
  created_at    DateTime     @default(now())

  orders   Order[]
  invoices Invoice[]

  @@map("Customer")
}

model Material {
  material_id   Int          @id @default(autoincrement())
  material_name String
  type          MaterialType

  constant_height_id    Int?
  constant_width_id     Int?
  constant_thickness_id Int?

  constant_value_unit String?

  height    ConstantValue? @relation("MaterialHeight", fields: [constant_height_id], references: [constant_value_id])
  width     ConstantValue? @relation("MaterialWidth", fields: [constant_width_id], references: [constant_value_id])
  thickness ConstantValue? @relation("MaterialThickness", fields: [constant_thickness_id], references: [constant_value_id])
  notes     String?

  colors  Color[]
  batches Batch[]
  rulers  Ruler[]

  @@map("Material")
}

model Ruler {
  ruler_id    Int       @id @default(autoincrement())
  ruler_type  RulerType
  material_id Int
  color_id    Int
  material    Material  @relation(fields: [material_id], references: [material_id])
  color       Color     @relation(fields: [color_id], references: [color_id])
  notes       String?

  order_items      OrderItem[]
  movements        WarehouseMovement[]
  production_items ProductionOrderItem[]

  @@map("Ruler")
}

model Color {
  color_id    Int     @id @default(autoincrement())
  material_id Int
  color_code  String  @unique
  color_name  String
  notes       String?

  material Material     @relation(fields: [material_id], references: [material_id])
  prices   PriceColor[]
  rulers   Ruler[]

  @@map("Color")
}

model PriceColor {
  price_color_id    Int          @id @default(autoincrement())
  color_id          Int
  constant_value_id Int
  price_color_By    PriceColorBy
  price_per_meter   Decimal      @db.Decimal(10, 2)
  notes             String?

  color          Color         @relation(fields: [color_id], references: [color_id])
  constant_value ConstantValue @relation(fields: [constant_value_id], references: [constant_value_id])

  @@map("PriceColor")
}

model ConstantType {
  constant_type_id    Int              @id @default(autoincrement())
  constants_Type_name String
  type                ConstantTypeEnum
  notes               String?

  values ConstantValue[]

  @@map("ConstantType")
}

model ConstantValue {
  constant_value_id Int     @id @default(autoincrement())
  constant_type_id  Int
  value             String
  unit              String?
  label             String?
  isDefault         Boolean @default(false)
  notes             String?

  type               ConstantType @relation(fields: [constant_type_id], references: [constant_type_id])
  materialsHeight    Material[]   @relation("MaterialHeight")
  materialsWidth     Material[]   @relation("MaterialWidth")
  materialsThickness Material[]   @relation("MaterialThickness")
  orderItems         OrderItem[]  @relation("ConstantValueOrderItems")
  priceColors        PriceColor[]

  @@map("ConstantValue")
}

model Batch {
  batch_id     Int      @id @default(autoincrement())
  batch_number String
  entry_date   DateTime
  material_id  Int?
  notes        String?

  material Material? @relation(fields: [material_id], references: [material_id])

  order_items      OrderItem[]
  movements        WarehouseMovement[]
  production_items ProductionOrderItem[]

  @@map("Batch")
}

model Order {
  order_id      Int         @id @default(autoincrement())
  customer_id   Int
  sales_user_id Int
  status        OrderStatus
  total_amount  Decimal     @db.Decimal(12, 2)
  created_at    DateTime    @default(now())
  notes         String?

  customer Customer @relation(fields: [customer_id], references: [customer_id])
  sales    Users    @relation(fields: [sales_user_id], references: [id])

  items    OrderItem[]
  invoices Invoice[]

  @@index([status])
  @@index([created_at])
  @@index([status, created_at])
  @@map("Order")
}

model OrderItem {
  order_item_id      Int      @id @default(autoincrement())
  order_id           Int
  type_item          Int?
  ruler_id           Int
  constant_width     Decimal  @db.Decimal(10, 2)
  length             Decimal  @db.Decimal(10, 2)
  constant_thickness Decimal  @db.Decimal(10, 2)
  batch_id           Int
  quantity           Int
  unit_price         Decimal? @db.Decimal(10, 2)
  subtotal           Decimal  @db.Decimal(12, 2)
  notes              String?

  constant_type_value ConstantValue? @relation("ConstantValueOrderItems", fields: [type_item], references: [constant_value_id])
  order               Order          @relation(fields: [order_id], references: [order_id])
  ruler               Ruler          @relation(fields: [ruler_id], references: [ruler_id])
  batch               Batch          @relation(fields: [batch_id], references: [batch_id])

  processes ProductionProcess[]

  @@map("OrderItem")
}

model Invoice {
  invoice_id       Int      @id @default(autoincrement())
  order_id         Int
  customer_id      Int
  total_amount     Decimal  @db.Decimal(12, 2)
  paid_amount      Decimal  @db.Decimal(12, 2)
  remaining_amount Decimal  @db.Decimal(12, 2)
  issued_by        Int
  issued_at        DateTime @default(now())
  notes            String?

  order    Order    @relation(fields: [order_id], references: [order_id])
  customer Customer @relation(fields: [customer_id], references: [customer_id])
  user     Users    @relation(fields: [issued_by], references: [id])

  @@map("Invoice")
}

model ProductionOrder {
  production_order_id Int              @id @default(autoincrement())
  issued_by           Int
  type                ProductionType
  status              ProductionStatus
  created_at          DateTime         @default(now())
  notes               String?

  user  Users                 @relation(fields: [issued_by], references: [id])
  items ProductionOrderItem[]

  @@index([created_at])
  @@index([status])
  @@index([created_at, status])
  @@map("ProductionOrder")
}

model ProductionOrderItem {
  production_order_item_id Int                 @id @default(autoincrement())
  production_order_id      Int
  type_item                Int
  constant_width           Decimal             @db.Decimal(10, 2)
  length                   Decimal             @db.Decimal(10, 2)
  constant_thickness       Decimal             @db.Decimal(10, 2)
  ruler_id                 Int
  batch_id                 Int
  source                   ProcessSource
  destination              MovementDestination
  created_at               DateTime            @default(now())
  notes                    String?

  production_order ProductionOrder @relation(fields: [production_order_id], references: [production_order_id])
  ruler            Ruler           @relation(fields: [ruler_id], references: [ruler_id])
  batch            Batch           @relation(fields: [batch_id], references: [batch_id])

  processes          ProductionProcess[]
  slites             Slite[]
  warehouseMovements WarehouseMovement[]

  @@map("ProductionOrderItem")
}

model ProductionProcess {
  process_id               Int      @id @default(autoincrement())
  production_order_item_id Int
  input_length             Decimal  @db.Decimal(10, 2)
  output_length            Decimal  @db.Decimal(10, 2)
  input_width              Decimal  @db.Decimal(10, 2)
  waste                    Decimal  @db.Decimal(10, 2)
  barcode                  String   @unique
  user_id                  Int
  created_at               DateTime @default(now())
  notes                    String?

  item                   ProductionOrderItem @relation(fields: [production_order_item_id], references: [production_order_item_id])
  user                   Users               @relation(fields: [user_id], references: [id])
  orderItem              OrderItem?          @relation(fields: [orderItemOrder_item_id], references: [order_item_id])
  orderItemOrder_item_id Int?

  @@index([created_at])
  @@map("ProductionProcess")
}

model Slite {
  slite_id                 Int      @id @default(autoincrement())
  production_order_item_id Int
  input_length             Decimal  @db.Decimal(10, 2)
  output_length            Decimal  @db.Decimal(10, 2)
  input_width              Decimal  @db.Decimal(10, 2)
  output_length_22         Decimal  @db.Decimal(10, 2)
  output_length_44         Decimal  @db.Decimal(10, 2)
  barcode                  String   @unique
  user_id                  Int
  created_at               DateTime @default(now())
  notes                    String?

  item ProductionOrderItem @relation(fields: [production_order_item_id], references: [production_order_item_id])
  user Users               @relation(fields: [user_id], references: [id])

  increases Increase[]

  @@map("Slite")
}

model Increase {
  increase Int     @id @default(autoincrement())
  slite_id Int
  width    Decimal @db.Decimal(10, 2)
  height   Decimal @db.Decimal(10, 2)
  notes    String?

  slite Slite @relation(fields: [slite_id], references: [slite_id])

  @@map("Increase")
}

model WarehouseMovement {
  movement_id              Int                 @id @default(autoincrement())
  production_order_item_id Int
  ruler_id                 Int
  batch_id                 Int
  quantity                 Int
  length                   Decimal             @db.Decimal(10, 2)
  width                    Decimal             @db.Decimal(10, 2)
  thickness                Decimal             @db.Decimal(10, 2)
  destination              MovementDestination
  user_id                  Int
  created_at               DateTime            @default(now())
  notes                    String?

  item  ProductionOrderItem @relation(fields: [production_order_item_id], references: [production_order_item_id])
  ruler Ruler               @relation(fields: [ruler_id], references: [ruler_id])
  batch Batch               @relation(fields: [batch_id], references: [batch_id])
  user  Users               @relation(fields: [user_id], references: [id])

  @@index([created_at])
  @@map("WarehouseMovement")
}

model Setting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("Settings")
}

model PasswordReset {
  id         Int       @id @default(autoincrement())
  phone      String
  otp        String
  expiresAt  DateTime
  isUsed     Boolean   @default(false)
  usedAt     DateTime?
  attempts   Int       @default(0)
  ip         String?
  userAgent  String?
  created_at DateTime  @default(now())

  @@index([phone])
  @@index([otp])
  @@index([expiresAt])
  @@index([created_at])
  @@map("PasswordReset")
}
